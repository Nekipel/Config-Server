Что такое Config Server и зачем он нужен
 
Для разработчика config-server — это еще один микросервис, еще одно простейшее Spring Boot приложение с минимальным набором зависимостей, которое крутится рядом с другими микросервисами.

Для чего он нужен

Разберем это на абстрактном примере.

Допустим, у нас есть некоторое количество микросервисов, каждый из них требует проперти для подключения к базе данных: некоторые — для mongo, некоторые — для mysql, а другие — для postgreSql.  Для этого нам нужно зайти в каждый микросервис и прописать для каждого свои проперти. Если мы будем использовать config-server/config-client, нужда заходить в каждый сервис отпадает. Мы храним свои проперти в репозитории — локальном или удаленном (git) — и config-server позволяет нашим сервисам обращаться к нему при своем запуске, а он в свою очередь перенаправит их в репозиторий, где хранятся проперти для него.

Чем еще полезен Config Server

На практике используется множество различных пропертей для различных нужд, например, мы хотим указать, какое количество раз за неделю будет отправляться рекламное письмо пользователям на почту. Со временем мы решили изменить это число. В стандартном случае нам придется открывать код микросервиса, править его файл проперти и редеплоить приложение в облако/сервер. В случае с config-server мы просто зайдем в репозиторий, изменим там эту настройку и воспользуемся функциональностью спринга для того, чтобы без редеплоя в силу вступили актуальные проперти нашего сервиса. Конкретный механизм в этой лекции не рассматривается, о нем подробно поговорим позже.



Config Server - это компонент, который используется в окружении микросервисов для централизованного хранения конфигурационных файлов и параметров приложений. Он позволяет управлять конфигурацией приложений в централизованном режиме, что облегчает процесс развертывания и обновления приложений.

Config Server работает следующим образом: он получает конфигурационные файлы из удаленного репозитория (например, Git) и предоставляет их в виде REST-сервиса для других микросервисов. Это позволяет разработчикам изменять конфигурацию приложения без необходимости перекомпиляции или перезапуска приложения.

Кроме того, Config Server обеспечивает безопасность конфигурации приложений, так как он может использовать шифрование для защиты конфиденциальной информации, такой как пароли и ключи доступа.

Таким образом, Config Server играет важную роль в окружении микросервисов, обеспечивая централизованное управление конфигурацией приложений, упрощая процесс развертывания и обновления приложений, а также обеспечивая безопасность конфигурации. gpt




Создание Config Server и Config Client

Примечание: сейчас у тебя уже должно быть два приложения: Eureka Server и Eureka Client.  Eureka Server будет использоваться далее в курсе как основной discovery сервер. Eureka Client был нужен только для примера работы с Eureka Server. Это приложение останется таким, какое оно есть сейчас и не получит развития в рамках этого курса.

Теперь нам нужно создать ещё два отдельных приложения: Config Server и Config Client. 

Ситуация с этими приложениями будет похожей: Config Server будет использоваться как основной сервер конфигурации здесь и далее по ходу курса. Config Client будет нужен только для примера работы с Config Server. 

Давай узнаем, как создавать Config Server и Config Client. Для начала создадим новые приложения сервера и клиента. 

Добавляем зависимости.

Для сервера:

Web

Config Server

Eureka Discovery Client

Для клиента:

Web

Config Client

Eureka Discovery Client

Предлагаем воспользоваться заготовками для сервера: https://github.com/KataAcademy/srping-cloud-course/tree/master/config-server и клиента: https://github.com/KataAcademy/srping-cloud-course/tree/master/config-client 

Все необходимые зависимости и версии уже добавлены. Тебе остается только написать код.

В application.yml на стороне сервера укажем основную информацию.

server:
 port: 8888
spring:
 application:
   name: config-server
Также не забываем про путь к Eureka Server
eureka:
 client:
   serviceUrl:
     defaultZone: ${EUREKA_URI:http://localhost:8761/eureka}
Основной класс помечаем аннотацией @EnableConfigServer и @EnableEurekaClient

Теперь можем приступить к основной информации в applicatiom.yml для сервера

spring:
 profiles:
   active: native
---
spring:
 profiles: native
 cloud:
либо
spring:
 profiles: git
 cloud:
   config:
     server:
       git:
         uri: https://github.com/myGitHub/my-example
         search-paths:
           - "ms-config-properties/{application}/{profile}"
Здесь мы указываем профиль для того чтобы потом легко переключиться с одного способа хранения на другой. У нас указан по умолчанию профиль = native.
Вообще хранение может осуществляться локально (native) либо удаленно на Git (git).

Здесь надо дать пояснения насчет пути. Параметр search-location принимает в качестве значения путь к папке, которая будет локальным хранилищем файлов свойств для каждого отдельного Config Client. 
 

/home/ks/IdeaProjects/my-example - произвольный путь до папки с свойствами. На вашей локальной машине он может быть совсем другим
ms-config-properties - название папки, которая будет хранить файлы свойств для каждого отдельного клиента
{application} - название приложения. Должно совпадать с параметром name в файле свойств у клиента, который будет запрашивать конкретно этот файл свойств
{profile}- профиль приложения. dev, master или test.

![image](https://github.com/Nekipel/Config-Server/assets/88710417/9568305d-6649-4852-a999-476ad8da6249)
![image](https://github.com/Nekipel/Config-Server/assets/88710417/472fb8a7-948a-4472-ba54-a1112f572e99)

Далее нам надо создать либо локальный репозиторий для хранения конфигов, либо удаленный на git.

Оба варианта должны соответствовать определенным правилам:

Имя должно соответствовать тому, которое ты указал в файле свойств в Config Server (см. выше — ms-config-properties).

Внутри ms-config-properties мы создаем директории, соответствующие именам сервисов, которые будут к нему обращаться.

 

Для настройки работы с git репозиторием нужно указать примерно следующее.

spring:
 profiles:
   active: git
 cloud:
   config:
     server:
       git:
         uri: https://github.com/IvanCherepica/ms-config-properties
         search-paths:
           - "/{application}/{profile}"
 

На клиенте в основном классе поставим аннотацию @EnableEurekaClient.
Не забываем на клиенте указать имя клиента, порт, на котором он будет работать, и путь к Eureka Server. Подобные настройки нужно будет производить с абсолютно каждым приложением, созданным далее в рамках этого курса

Также потребуется указать следующие проперти.

spring:
 config:
  import: "optional:configserver:"
 cloud:
  config:
   enabled: true
   discovery: 
    enabled: true
Это необходимо, чтобы config-server мог обнаруживаться и взаимодействовать с сервисами с помощью eureka-server.

Далее нам надо создать локальный или удаленный (git) репозиторий. Ты можешь выбрать любой вариант, приватные git-репозитории тоже поддерживаются, нужно лишь добавить логин и пароль.

 Оба вариант должны соответствовать опереденным правилам:

Имя должно соответствовать тому, которое ты указал в файле свойств в Config Server (см. выше — ms-config-properties).

Внутри ms-config-properties мы создаем директории, соответствующие именам сервисов, которые будут к нему обращаться.  

Например, service_1 будет обращаться за своей конфигурацией в Config Server, а тот в свою очередь будет отсылать его в ms-config-properties за конфигурацией. Значит, service_1 идет в ms-config-properties, находит там директорию с названием service_1 и смело переходит туда. Если у нас, например, есть service_2, то для него будет директория с названием service_2 и т. д. для остальных сервисов. Имена должны строго совпадать!

Обрати внимание на то, как называется папка для service_1.

Она должна называться точно так же, как называется клиентский сервис, который будет обращаться в config server. Если сервис называется user-service, значит и папка внутри ms-config-properties тоже должна называться user-service. Файлы .yml тоже должны называться user-service по имени клиентского сервиса.

Клиентский сервис будет искать свой путь по своему имени. Если имя будет другим, он не найдет нужный файл.

Почему здесь три вложенные папки: dev, master и test? Мы сделали так для примера для dev окружения, master и тестовой среды. 

Зачастую на тестовом сервере нужны одни данные, а на продакшене — другие.

Профили

Обрати внимание, мы используем три папки с названиями:

dev

master

test

Это нужно для использования с различными профилями. 

Чтобы нужные файлы успешно находились, Config Client должен быть обязательно запущен с одним из трех профилей.

Самый простой способ указать, какой профиль мы хотим использовать для клиента, является окно конфигурации запуска.
![image](https://github.com/Nekipel/Config-Server/assets/88710417/da67110f-ad91-458a-9be0-c0472381de8e)

Параметр -Dspring.profiles.active=dev говорит spring boot, что это приложение должно быть запущено именно с этим профилем.
Создайте папку config-client и внутри неё три директории: dev, master, test. Внутри каждой из них создайте пустой config-client.yml.
Запустите сначала Eureka Server, затем Config Server и потом Config Client. Важно: Config Client должен запускаться с профилем dev.
Если вы всё сделал правильно, в логах Config Server вы увидите следующее сообщение:

Adding property source: Config resource 'file [/home/ivan/spring-cloud-course/ms-config-properties/config-client/dev/config-client.yml]' via location '/home/ivan/spring-cloud-course/ms-config-properties/config-client/dev/'

Далее мы начнем делать наше небольшое приложение и будем более детально знакомиться с Eureka и делать ее реплики в разных зонах. Также будем использовать Config Server и Client для настройки следующих приложений. Впереди будет много всего интересного!


Статья написана максимально непонятно, на от%%бись, все пришлось смотреть в репозитории https://github.com/IvanCherepica/spring-cloud-course
В итоге так и не понял правильно сделал или нет так как в логах The response status is 200 а того что написано в статье нет, но все вроде работает. Автора статьи КАЗНИТЬ АНАЛЬНО!!!

Если у вас ничего не получается, то мой git вам в помощь) 

https://github.com/NikReDMooN/Java_Advance_4_1_2

В такой конфигурации config-server не поднимался
spring:  
  profiles: native 
   cloud:    
    config:      
     server:        
      native:          
        search-locations: /home/ks/IdeaProjects/my-example/ms-config-properties/{application}/{profile}
Исправил на следующую

spring:
  config:
    activate:
      on-profile: native
  cloud:
    config:
      server:
        native:
          search-locations: /home/ks/IdeaProjects/my-example/ms-config-properties/{application}/{profile}


Михаил Александров
20.02.2023 01:18
Настройки для сервера:
--------------------------------------------------------------------------------Дальше спойлер-----------------------------------------------------------------------------------
Постарайтесь разобраться что к чему, я не получал заветную строчку пока не установил defaul-lable(это для GitHub-соединения, в нее вписываете название ветки на которой находятся ваши properties либо YAML файлы. По умолчанию в Spring это ветка master, у меня же ветка main)

3 папки (dev, master, test) создаются непосредственно в папке ms-config-properties в репозитории, локальном или удаленом (в зависимости от того что вы выбрали) и в них помещаем уже по одному файлу конфигураций с именем config-client в выбраном вами расширением (properties или YAML). Добавьте в каждый файл настроек ХОТЯБЫ ПО ОДНОЙ СТРОЧКЕ (у меня это было просто message=Hello! - это никак не повлиятет на настройки, но даст понять config-server что фаил не пуст и его необходимо подгрузить), иначе не сможете понять все заработало или нет.


server:
  port: 8888

spring:
  application:
    name: config-server
  profiles:
    active: git
  cloud:
    config:
      server:
        git:
          uri: https://github.com/Morrrun/eureka-config
          searchPaths: "/ms-config-properties/{application}/{profile}"
          default-label: main

eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_URI:http://alexsandrov:8761/eureka/}

user avatar
Михаил Александров
20.02.2023 00:10
Читать много, но все же получше будет (перед прочтением посторайтесь побольше разобраться с тем что написано выше, тогда легче будет все понять)
https://cloud.spring.io/spring-cloud-static/spring-cloud-config/2.2.0.RELEASE/reference/html/#_quick_start 

user avatar
Александр Костенко
31.12.2022 19:24
Долго делал Config-Client. чтобы запустить. В начале выскакивала ошибка Web server failed to start. Port 8080 was already in use.
Нашел выход добавил в настройку 
eureka: 
  client:   
  serviceUrl:
       defaultZone: ${EUREKA_URI:http://localhost:8761/eureka}">http://localhost:8761/eureka}  
 instance: 
   prefer-ip-address: true
spring:
main:
       web-application-type: none
  application:
    name: config-client
  cloud:
    config:
      discovery:
        enabled: true
        service-id: config-server
в итоге все заканчивалось без ошибки, но сервер не запускался.
добавил вот так вроде заработло.

eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_URI:http://localhost:8761/eureka}
  instance:
   prefer-ip-address: true

server:
  port: 8082

spring:
  application:
    name: config-client
  cloud:
    config:
      discovery:
        enabled: true
        service-id: config-server
